var ngms;!function(t){"use strict";var e=angular.module("ngms",[]),s=function(){function t(t,e){this.$channel=t,this.$topicName=e}return t.prototype.getName=function(){return this.$topicName},t.prototype.getChannelName=function(){return this.$channel.getName()},t.prototype.publish=function(t){this.$channel.publish(this.$topicName,t)},t.prototype.subscribe=function(t){return this.$channel.subscribe(this.$topicName,t)},t.prototype.unsubscribe=function(t){if(t.topicName!==this.$topicName)throw new Error("You can only unsubscribe tokens related to topic "+this.$topicName);this.$channel.unsubscribe(t)},t.prototype.unsubscribeAll=function(){var t=this.$channel.getRegistry(),e=t.getChannelSubs(this.$channel.getName());e[this.$topicName]=[]},t}(),i=function(){function t(t,e){this.$subscriptions={},this.$registry=e,this.$channelName=t}return t.prototype.getRegistry=function(){return this.$registry},t.prototype.getName=function(){return this.$channelName},t.prototype.getTopic=function(t){return new s(this,t)},t.prototype.publish=function(t,e){var s;s="string"==typeof e?{data:e,$msgId:this.$registry.generateUUID()}:e,this.$registry.publish(this.$channelName,t,s)},t.prototype.subscribeAll=function(t){return this.subscribe(this.$registry.$allTopicsName,t)},t.prototype.subscribe=function(t,e){var s=this.$registry.generateUUID(),i=this.$registry.getTopicSubs(this.$channelName,t),n={channelName:this.$channelName,topicName:t,tokenId:s};return i.push({token:n,callback:e}),this.$subscriptions[s]=n,n},t.prototype.unsubscribeAll=function(){for(var t in this.$subscriptions)this.unsubscribe(this.$subscriptions[t]);this.$subscriptions={}},t.prototype.unsubscribe=function(t){if(t){if(t.channelName!==this.$channelName)throw new Error("You can only unsubscribe tokens related to channel "+this.$channelName);this.$registry.removeToken(t),delete this.$subscriptions[t.tokenId]}},t}(),n=function(){function t(){this.$allTopicsName="$$all-topics",this.$allChannelsName="$$all-channels",this.$subscribers={}}return t.prototype.getChannelSubs=function(t){return this.$subscribers[t]=this.$subscribers[t]||{},this.$subscribers[t]},t.prototype.getTopicSubs=function(t,e){var s=this.getChannelSubs(t);return s[e]=s[e]||[],s[e]},t.prototype.removeToken=function(t){var e=this.getTopicSubs(t.channelName,t.topicName),s=e.filter(function(e){return e.token.tokenId!==t.tokenId});0===s.length?(delete this.$subscribers[t.channelName][t.topicName],0===Object.keys(this.$subscribers[t.channelName]).length&&delete this.$subscribers[t.channelName]):this.$subscribers[t.channelName][t.topicName]=s},t.prototype.publish=function(t,e,s){var i=this.getTopicSubs(t,e),n=this.getTopicSubs(t,this.$allTopicsName),r=this.getTopicSubs(this.$allChannelsName,this.$allTopicsName);this.$publish(t,e,s,i),this.$publish(t,e,s,n),this.$publish(t,e,s,r)},t.prototype.$publish=function(t,e,s,i){i.forEach(function(i){i.callback(s,e,t)})},t.prototype.generateUUID=function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var s=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?s:3&s|8).toString(16)});return e},t}(),r=function(){function t(){this.$registry=new n}return t.prototype.getChannel=function(t){return new i(t,this.$registry)},t.prototype.getTopic=function(t,e){return new i(t,this.$registry).getTopic(e)},t.prototype.subscribeAllChannels=function(t){var e=this.$registry.generateUUID(),s=this.$registry.getTopicSubs(this.$registry.$allChannelsName,this.$registry.$allTopicsName),i={channelName:this.$registry.$allChannelsName,topicName:this.$registry.$allTopicsName,tokenId:e};return s.push({token:i,callback:t}),i},t.prototype.unsubscribeAllChannels=function(t){if(t.channelName!==this.$registry.$allChannelsName&&t.topicName!==this.$registry.$allTopicsName)throw new Error("MessageService only allows unsubscribe to all-channels subscriptions");this.$registry.removeToken(t)},t.prototype.getRegistryStats=function(){var t={},e=this;return t.totalChannels=Object.keys(this.$registry.$subscribers).length,t.totalTopics=0,t.totalSubscriptions=0,t.channels=[],Object.keys(this.$registry.$subscribers).forEach(function(s){var i=e.$registry.$subscribers[s],n={};n.name=s,n.totalTopics=Object.keys(i).length,n.totalSubscriptions=0,n.topics=[],Object.keys(i).forEach(function(t){var e=i[t],s={};s.name=t,s.totalSubscriptions=e.length,n.totalSubscriptions+=e.length,n.topics.push(s)}),t.totalTopics+=n.totalTopics,t.totalSubscriptions+=n.totalSubscriptions,t.channels.push(n)}),t},t}();e.service("ngmsMessageService",r)}(ngms||(ngms={}));